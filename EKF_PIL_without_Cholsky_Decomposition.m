function [zSOC,xf,P1 ] = EKF_PIL(Current,Voltage,Temperature,x,P)
dt=1;
Cn= 5.0051 * 3600;
eta=1/Cn;
%Battery Parameters for C1Prime
    C1Prime40degC = [2083.22012546450	2710.01837061520	1922.06682435615	1792.22956717441	1760.75618244066	2031.83758202416	2051.02454747417	2081.85432467993	2125.33315186056	2311.18588509504	2379.96248975183	2457.47515998566	2478.73741334316	2191.20325428413	2391.52304665939	2429.38840120526	2447.03256808091	2462.05645988043	2506.47947890751	2461.59012680437	2387.68917159897	2382.56661211729	2432.03912177379	2521.40506993686	2375.38685864789	2302.44681684798	2218.41986586592	2143.84503929650	2238.51356492489	2212.66429743328	2166.81322572638	1869.89292898027];
    C1Prime30degC = [2083.22012546450	2710.01837061520	1922.06682435615	1792.22956717441	1760.75618244066	2031.83758202416	2051.02454747417	2081.85432467993	2125.33315186056	2311.18588509504	2379.96248975183	2457.47515998566	2478.73741334316	2191.20325428413	2391.52304665939	2429.38840120526	2447.03256808091	2462.05645988043	2506.47947890751	2461.59012680437	2387.68917159897	2382.56661211729	2432.03912177379	2521.40506993686	2375.38685864789	2302.44681684798	2218.41986586592	2143.84503929650	2238.51356492489	2212.66429743328	2166.81322572638	1869.89292898027];
    C1Prime20degC = [2083.22012546450	2710.01837061520	1922.06682435615	1792.22956717441	1760.75618244066	2031.83758202416	2051.02454747417	2081.85432467993	2125.33315186056	2311.18588509504	2379.96248975183	2457.47515998566	2478.73741334316	2191.20325428413	2391.52304665939	2429.38840120526	2447.03256808091	2462.05645988043	2506.47947890751	2461.59012680437	2387.68917159897	2382.56661211729	2432.03912177379	2521.40506993686	2375.38685864789	2302.44681684798	2218.41986586592	2143.84503929650	2238.51356492489	2212.66429743328	2166.81322572638	1869.89292898027];
    C1Prime10degC = [2083.22012546450	2710.01837061520	1922.06682435615	1792.22956717441	1760.75618244066	2031.83758202416	2051.02454747417	2081.85432467993	2125.33315186056	2311.18588509504	2379.96248975183	2457.47515998566	2478.73741334316	2191.20325428413	2391.52304665939	2429.38840120526	2447.03256808091	2462.05645988043	2506.47947890751	2461.59012680437	2387.68917159897	2382.56661211729	2432.03912177379	2521.40506993686	2375.38685864789	2302.44681684798	2218.41986586592	2143.84503929650	2238.51356492489	2212.66429743328	2166.81322572638	1869.89292898027];
    C1Prime0degC = [2083.22012546450	2710.01837061520	1922.06682435615	1792.22956717441	1760.75618244066	2031.83758202416	2051.02454747417	2081.85432467993	2125.33315186056	2311.18588509504	2379.96248975183	2457.47515998566	2478.73741334316	2191.20325428413	2391.52304665939	2429.38840120526	2447.03256808091	2462.05645988043	2506.47947890751	2461.59012680437	2387.68917159897	2382.56661211729	2432.03912177379	2521.40506993686	2375.38685864789	2302.44681684798	2218.41986586592	2143.84503929650	2238.51356492489	2212.66429743328	2166.81322572638	1869.89292898027];
    C1Primen10degC = [2083.22012546450	2710.01837061520	1922.06682435615	1792.22956717441	1760.75618244066	2031.83758202416	2051.02454747417	2081.85432467993	2125.33315186056	2311.18588509504	2379.96248975183	2457.47515998566	2478.73741334316	2191.20325428413	2391.52304665939	2429.38840120526	2447.03256808091	2462.05645988043	2506.47947890751	2461.59012680437	2387.68917159897	2382.56661211729	2432.03912177379	2521.40506993686	2375.38685864789	2302.44681684798	2218.41986586592	2143.84503929650	2238.51356492489	2212.66429743328	2166.81322572638	1869.89292898027];
    C1Primen20degC = [2083.22012546450	2710.01837061520	1922.06682435615	1792.22956717441	1760.75618244066	2031.83758202416	2051.02454747417	2081.85432467993	2125.33315186056	2311.18588509504	2379.96248975183	2457.47515998566	2478.73741334316	2191.20325428413	2391.52304665939	2429.38840120526	2447.03256808091	2462.05645988043	2506.47947890751	2461.59012680437	2387.68917159897	2382.56661211729	2432.03912177379	2521.40506993686	2375.38685864789	2302.44681684798	2218.41986586592	2143.84503929650	2238.51356492489	2212.66429743328	2166.81322572638	1869.89292898027];

%Battery Parameters for C2Prime
    C2Prime40degC = [14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	6234.50183254339];
    C2Prime30degC = [14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	6234.50183254339];
    C2Prime20degC = [14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	6234.50183254339];
    C2Prime10degC = [14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	6234.50183254339];
    C2Prime0degC = [14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	6234.50183254339];
    C2Primen10degC = [14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	6234.50183254339];
    C2Primen20degC = [14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	14645.0178095437	6234.50183254339];
      
%Battery Parameters for C3Prime
    C3Prime40degC = [85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	59986.9166699411];
    C3Prime30degC = [85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	59986.9166699411];
    C3Prime20degC = [85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	59986.9166699411];
    C3Prime10degC = [85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	59986.9166699411];
    C3Prime0degC = [85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	59986.9166699411];
    C3Primen10degC = [85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	59986.9166699411];
    C3Primen20degC = [85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	85591.7925817648	59986.9166699411];
    
%Battery Parameters for R0Prime   
    R0Prime40degC = [0.0484758072653625	0.0545124731665738	0.0391165177345883	0.0331425295928973	0.0292239064936599	0.0275061131710844	0.0254690984701618	0.0207900967816771	0.0201311219742891	0.0212539594594175	0.0218237884756365	0.0206912267476171	0.0218159237362062	0.0211264588391411	0.0213417230755651	0.0204032036748232	0.0203518830478236	0.0188993682913442	0.0183604649054052	0.0190299697687320	0.0194723832935214	0.0208489776320436	0.0209495521609657	0.0222610849727999	0.0214569764628027	0.0205550583383513	0.0202940962399294	0.0182626061549480	0.0182009069782018	0.0166674963878994	0.0195324265745736	0.0183965279144621];
    R0Prime30degC = [0.0484758072653625	0.0545124731665738	0.0391165177345883	0.0331425295928973	0.0292239064936599	0.0275061131710844	0.0254690984701618	0.0207900967816771	0.0201311219742891	0.0212539594594175	0.0218237884756365	0.0206912267476171	0.0218159237362062	0.0211264588391411	0.0213417230755651	0.0204032036748232	0.0203518830478236	0.0188993682913442	0.0183604649054052	0.0190299697687320	0.0194723832935214	0.0208489776320436	0.0209495521609657	0.0222610849727999	0.0214569764628027	0.0205550583383513	0.0202940962399294	0.0182626061549480	0.0182009069782018	0.0166674963878994	0.0195324265745736	0.0183965279144621];
    R0Prime20degC = [0.0484758072653625	0.0545124731665738	0.0391165177345883	0.0331425295928973	0.0292239064936599	0.0275061131710844	0.0254690984701618	0.0207900967816771	0.0201311219742891	0.0212539594594175	0.0218237884756365	0.0206912267476171	0.0218159237362062	0.0211264588391411	0.0213417230755651	0.0204032036748232	0.0203518830478236	0.0188993682913442	0.0183604649054052	0.0190299697687320	0.0194723832935214	0.0208489776320436	0.0209495521609657	0.0222610849727999	0.0214569764628027	0.0205550583383513	0.0202940962399294	0.0182626061549480	0.0182009069782018	0.0166674963878994	0.0195324265745736	0.0183965279144621];
    R0Prime10degC = [0.0484758072653625	0.0545124731665738	0.0391165177345883	0.0331425295928973	0.0292239064936599	0.0275061131710844	0.0254690984701618	0.0207900967816771	0.0201311219742891	0.0212539594594175	0.0218237884756365	0.0206912267476171	0.0218159237362062	0.0211264588391411	0.0213417230755651	0.0204032036748232	0.0203518830478236	0.0188993682913442	0.0183604649054052	0.0190299697687320	0.0194723832935214	0.0208489776320436	0.0209495521609657	0.0222610849727999	0.0214569764628027	0.0205550583383513	0.0202940962399294	0.0182626061549480	0.0182009069782018	0.0166674963878994	0.0195324265745736	0.0183965279144621];
    R0Prime0degC = [0.0484758072653625	0.0545124731665738	0.0391165177345883	0.0331425295928973	0.0292239064936599	0.0275061131710844	0.0254690984701618	0.0207900967816771	0.0201311219742891	0.0212539594594175	0.0218237884756365	0.0206912267476171	0.0218159237362062	0.0211264588391411	0.0213417230755651	0.0204032036748232	0.0203518830478236	0.0188993682913442	0.0183604649054052	0.0190299697687320	0.0194723832935214	0.0208489776320436	0.0209495521609657	0.0222610849727999	0.0214569764628027	0.0205550583383513	0.0202940962399294	0.0182626061549480	0.0182009069782018	0.0166674963878994	0.0195324265745736	0.0183965279144621];
    R0Primen10degC = [0.0484758072653625	0.0545124731665738	0.0391165177345883	0.0331425295928973	0.0292239064936599	0.0275061131710844	0.0254690984701618	0.0207900967816771	0.0201311219742891	0.0212539594594175	0.0218237884756365	0.0206912267476171	0.0218159237362062	0.0211264588391411	0.0213417230755651	0.0204032036748232	0.0203518830478236	0.0188993682913442	0.0183604649054052	0.0190299697687320	0.0194723832935214	0.0208489776320436	0.0209495521609657	0.0222610849727999	0.0214569764628027	0.0205550583383513	0.0202940962399294	0.0182626061549480	0.0182009069782018	0.0166674963878994	0.0195324265745736	0.0183965279144621];
    R0Primen20degC = [0.0484758072653625	0.0545124731665738	0.0391165177345883	0.0331425295928973	0.0292239064936599	0.0275061131710844	0.0254690984701618	0.0207900967816771	0.0201311219742891	0.0212539594594175	0.0218237884756365	0.0206912267476171	0.0218159237362062	0.0211264588391411	0.0213417230755651	0.0204032036748232	0.0203518830478236	0.0188993682913442	0.0183604649054052	0.0190299697687320	0.0194723832935214	0.0208489776320436	0.0209495521609657	0.0222610849727999	0.0214569764628027	0.0205550583383513	0.0202940962399294	0.0182626061549480	0.0182009069782018	0.0166674963878994	0.0195324265745736	0.0183965279144621];

%Battery Parameters for R1Prime      
    R1Prime40degC = [0.00287683070774836	0.00234459410267763	0.00272577626318100	0.00323007022153691	0.00350739972691069	0.00319771459072455	0.00348986847313350	0.00359527118458082	0.00345205719293417	0.00329688343449480	0.00330479023441111	0.00325684399151645	0.00317357002362157	0.00337980897958290	0.00333862845415180	0.00339545782721410	0.00338684639743177	0.00335804099160325	0.00345064277015979	0.00344126868265704	0.00345498039121955	0.00347173672981018	0.00335045299074102	0.00341672082169619	0.00369611322174702	0.00381657703668690	0.00383254430158801	0.00387797681299086	0.00364875611655038	0.00369552950065015	0.00368133192176345	0.00416562047119377];
    R1Prime30degC = [0.00287683070774836	0.00234459410267763	0.00272577626318100	0.00323007022153691	0.00350739972691069	0.00319771459072455	0.00348986847313350	0.00359527118458082	0.00345205719293417	0.00329688343449480	0.00330479023441111	0.00325684399151645	0.00317357002362157	0.00337980897958290	0.00333862845415180	0.00339545782721410	0.00338684639743177	0.00335804099160325	0.00345064277015979	0.00344126868265704	0.00345498039121955	0.00347173672981018	0.00335045299074102	0.00341672082169619	0.00369611322174702	0.00381657703668690	0.00383254430158801	0.00387797681299086	0.00364875611655038	0.00369552950065015	0.00368133192176345	0.00416562047119377];
    R1Prime20degC = [0.00287683070774836	0.00234459410267763	0.00272577626318100	0.00323007022153691	0.00350739972691069	0.00319771459072455	0.00348986847313350	0.00359527118458082	0.00345205719293417	0.00329688343449480	0.00330479023441111	0.00325684399151645	0.00317357002362157	0.00337980897958290	0.00333862845415180	0.00339545782721410	0.00338684639743177	0.00335804099160325	0.00345064277015979	0.00344126868265704	0.00345498039121955	0.00347173672981018	0.00335045299074102	0.00341672082169619	0.00369611322174702	0.00381657703668690	0.00383254430158801	0.00387797681299086	0.00364875611655038	0.00369552950065015	0.00368133192176345	0.00416562047119377];
    R1Prime10degC = [0.00287683070774836	0.00234459410267763	0.00272577626318100	0.00323007022153691	0.00350739972691069	0.00319771459072455	0.00348986847313350	0.00359527118458082	0.00345205719293417	0.00329688343449480	0.00330479023441111	0.00325684399151645	0.00317357002362157	0.00337980897958290	0.00333862845415180	0.00339545782721410	0.00338684639743177	0.00335804099160325	0.00345064277015979	0.00344126868265704	0.00345498039121955	0.00347173672981018	0.00335045299074102	0.00341672082169619	0.00369611322174702	0.00381657703668690	0.00383254430158801	0.00387797681299086	0.00364875611655038	0.00369552950065015	0.00368133192176345	0.00416562047119377];
    R1Prime0degC = [0.00287683070774836	0.00234459410267763	0.00272577626318100	0.00323007022153691	0.00350739972691069	0.00319771459072455	0.00348986847313350	0.00359527118458082	0.00345205719293417	0.00329688343449480	0.00330479023441111	0.00325684399151645	0.00317357002362157	0.00337980897958290	0.00333862845415180	0.00339545782721410	0.00338684639743177	0.00335804099160325	0.00345064277015979	0.00344126868265704	0.00345498039121955	0.00347173672981018	0.00335045299074102	0.00341672082169619	0.00369611322174702	0.00381657703668690	0.00383254430158801	0.00387797681299086	0.00364875611655038	0.00369552950065015	0.00368133192176345	0.00416562047119377];
    R1Primen10degC = [0.00287683070774836	0.00234459410267763	0.00272577626318100	0.00323007022153691	0.00350739972691069	0.00319771459072455	0.00348986847313350	0.00359527118458082	0.00345205719293417	0.00329688343449480	0.00330479023441111	0.00325684399151645	0.00317357002362157	0.00337980897958290	0.00333862845415180	0.00339545782721410	0.00338684639743177	0.00335804099160325	0.00345064277015979	0.00344126868265704	0.00345498039121955	0.00347173672981018	0.00335045299074102	0.00341672082169619	0.00369611322174702	0.00381657703668690	0.00383254430158801	0.00387797681299086	0.00364875611655038	0.00369552950065015	0.00368133192176345	0.00416562047119377];
    R1Primen20degC = [0.00287683070774836	0.00234459410267763	0.00272577626318100	0.00323007022153691	0.00350739972691069	0.00319771459072455	0.00348986847313350	0.00359527118458082	0.00345205719293417	0.00329688343449480	0.00330479023441111	0.00325684399151645	0.00317357002362157	0.00337980897958290	0.00333862845415180	0.00339545782721410	0.00338684639743177	0.00335804099160325	0.00345064277015979	0.00344126868265704	0.00345498039121955	0.00347173672981018	0.00335045299074102	0.00341672082169619	0.00369611322174702	0.00381657703668690	0.00383254430158801	0.00387797681299086	0.00364875611655038	0.00369552950065015	0.00368133192176345	0.00416562047119377];
    
%Battery Parameters for R2Prime         
    R2Prime40degC = [0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00834979408446943];
    R2Prime30degC = [0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00834979408446943];
    R2Prime20degC = [0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00834979408446943];
    R2Prime10degC = [0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00834979408446943];
    R2Prime0degC = [0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00834979408446943];
    R2Primen10degC = [0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00834979408446943];
    R2Primen20degC = [0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00355457447699796	0.00834979408446943];
   
%Battery Parameters for R3Prime         
    R3Prime40degC = [0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00623609270284905];
    R3Prime30degC = [0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00623609270284905];
    R3Prime20degC = [0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00623609270284905];
    R3Prime10degC = [0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00623609270284905];
    R3Prime0degC = [0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00623609270284905];
    R3Primen10degC = [0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00623609270284905];
    R3Primen20degC = [0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00437055892893557	0.00623609270284905];
    
%Breakpoint 1: size 32         
    SOC_LUTPrime = [0	0.0127831983313522	0.0456929302942497	0.0786057313711412	0.111518526898098	0.144429840592439	0.177330986806062	0.210233775800412	0.243145794336484	0.276045492017101	0.308946077687300	0.341857352532097	0.374755879176453	0.407653651029663	0.440555113589575	0.473465727992119	0.506376225846031	0.539285924509320	0.572197948595327	0.605104261798333	0.638011840386493	0.670922010794247	0.703832425399136	0.736737079171609	0.769647343928256	0.802545881672480	0.835451273586293	0.868352935943861	0.901263439347708	0.934176001777399	0.967088003663667	1];
    
    Uocv_Poly = [1.85860168453613	-7.25792086526517	23.1888485334774	-44.8281291246205	44.3402094944622	-22.2025482897519	6.29893272877670	2.77742988616164];

%Breakpoint 2: size 7           
    temp = [-20 -10 0 10 20 30 40];

    Matrix_C1Prime = [C1Primen20degC; C1Primen10degC; C1Prime0degC; C1Prime10degC; C1Prime20degC; C1Prime30degC; C1Prime40degC];
    Matrix_C2Prime = [C2Primen20degC; C2Primen10degC; C2Prime0degC; C2Prime10degC; C2Prime20degC; C2Prime30degC; C2Prime40degC];
    Matrix_C3Prime = [C3Primen20degC; C3Primen10degC; C3Prime0degC; C3Prime10degC; C3Prime20degC; C3Prime30degC; C3Prime40degC];
    Matrix_R0Prime = [R0Primen20degC; R0Primen10degC; R0Prime0degC; R0Prime10degC; R0Prime20degC; R0Prime30degC; R0Prime40degC];
    Matrix_R1Prime = [R1Primen20degC; R1Primen10degC; R1Prime0degC; R1Prime10degC; R1Prime20degC; R1Prime30degC; R1Prime40degC];
    Matrix_R2Prime = [R2Primen20degC; R2Primen10degC; R2Prime0degC; R2Prime10degC; R2Prime20degC; R2Prime30degC; R2Prime40degC];
    Matrix_R3Prime = [R3Primen20degC; R3Primen10degC; R3Prime0degC; R3Prime10degC; R3Prime20degC; R3Prime30degC; R3Prime40degC];

    % output_value = interp2(x2_breakpoints, x1_breakpoints, table_data, input2, input1);

    if x(4) > 1
    C1 = interp2(SOC_LUTPrime, temp, Matrix_C1Prime, 1, Temperature);
    C2 = interp2(SOC_LUTPrime, temp, Matrix_C2Prime, 1, Temperature);
    C3 = interp2(SOC_LUTPrime, temp, Matrix_C3Prime, 1, Temperature);
    R0 = interp2(SOC_LUTPrime, temp, Matrix_R0Prime, 1, Temperature);
    R1 = interp2(SOC_LUTPrime, temp, Matrix_R1Prime, 1, Temperature);
    R2 = interp2(SOC_LUTPrime, temp, Matrix_R2Prime, 1, Temperature);
    R3 = interp2(SOC_LUTPrime, temp, Matrix_R3Prime, 1, Temperature);
    elseif x(4) < 0
    C1 = interp2(SOC_LUTPrime, temp, Matrix_C1Prime, 0, Temperature);
    C2 = interp2(SOC_LUTPrime, temp, Matrix_C2Prime, 0, Temperature);
    C3 = interp2(SOC_LUTPrime, temp, Matrix_C3Prime, 0, Temperature);
    R0 = interp2(SOC_LUTPrime, temp, Matrix_R0Prime, 0, Temperature);
    R1 = interp2(SOC_LUTPrime, temp, Matrix_R1Prime, 0, Temperature);
    R2 = interp2(SOC_LUTPrime, temp, Matrix_R2Prime, 0, Temperature);
    R3 = interp2(SOC_LUTPrime, temp, Matrix_R3Prime, 0, Temperature);
    else
    C1 = interp2(SOC_LUTPrime, temp, Matrix_C1Prime, x(4), Temperature);
    C2 = interp2(SOC_LUTPrime, temp, Matrix_C2Prime, x(4), Temperature);
    C3 = interp2(SOC_LUTPrime, temp, Matrix_C3Prime, x(4), Temperature);
    R0 = interp2(SOC_LUTPrime, temp, Matrix_R0Prime, x(4), Temperature);
    R1 = interp2(SOC_LUTPrime, temp, Matrix_R1Prime, x(4), Temperature);
    R2 = interp2(SOC_LUTPrime, temp, Matrix_R2Prime, x(4), Temperature);
    R3 = interp2(SOC_LUTPrime, temp, Matrix_R3Prime, x(4), Temperature);
    end

%% EXTENDED KALMAN FILTER
Q=diag([9.8933e-6 5.8643e-6 1.1502e-7 5.1534e-7]); % covariance of process
R=0.1712 + 1e-3;        % covariance of measurement  0.1

%%
curr=Current;
z = Voltage;     % measurments

  f=@(x)[( 1-dt/(R1*C1) )*x(1)+dt*curr/C1;...
       ( 1-dt/(R2*C2) )*x(2)+dt*curr/C2;...
       ( 1-dt/(R3*C3) )*x(3)+dt*curr/C3;...
       x(4)-dt*eta*curr];  % Nonlinear equations - Kalman Filter

  h=@(x) polyval(Uocv_Poly,x(4))  -x(1)-x(2)-x(3)-curr*R0; % Measurement equations - Kalman Filter

[xf,P1] = ekf1(f,x,P,h,z,Q,R);
xV_e = xf ;                           % save states
zSOC=xV_e(4,1);                             %SOC

%zV_e  = h_fun(xf);                          % save voltage estimated
function [x,P,V_error]=ekf1(f,x,P,h,z,Q,R)
% EKF   Extended Kalman Filter for nonlinear dynamic systems
% [x, P] = ekf(f,x,P,h,z,Q,R) returns state estimate, x and state covariance, P 
% for nonlinear dynamic system:
%           x_k+1 = f(x_k) + w_k
%           z_k   = h(x_k) + v_k
% where w ~ N(0,Q) meaning w is gaussian noise with covariance Q
%       v ~ N(0,R) meaning v is gaussian noise with covariance R
% Inputs:   f: function handle for f(x)
%           x: "a priori" state estimate
%           P: "a priori" estimated state covariance
%           h: fanction handle for h(x)
%           z: current measurement
%           Q: process noise covariance 
%           R: measurement noise covariance
% Output:   x: "a posteriori" state estimate
%           P: "a posteriori" state covariance
%

nx = numel(x);
nz = numel(z);

[x2,A]=jaccsd1(f,x);    %nonlinear update and linearization at current state
P=A*P*A'+Q;                 %partial update

%% START================================

P = (P + P')/2;              % enforce symmetry
P = P + 1e-12*eye(nx);  % tiny jitter to ensure positive definiteness

%% END ===================================

[z1,H]=jaccsd2(h,x2);    %nonlinear measurement and linearization
P12=P*H';                   %cross covariance
%%%%%% was comented
%     K=P12*inv(H*P12+R);               %Kalman filter gain
%     x=x1+K*(z-z1);                    %state estimate
%     P=P-K*P12';                       %state covariance matrix
%%%%%%    


%% START================================

% Innovation covariance
S = H*P12 + R;
S = (S + S')/2;                % enforce symmetry
S = S + 1e-12*eye(nz);    % tiny jitter for positive definiteness

%% END ===================================

S = real(S);
if S <= 0 || isnan(S)
    S = 1e-3;
end

%Rchol=chol(S);            %Cholesky factorization
%U=P12/Rchol;                    %K=U/R'; Faster because of back substitution
%x=x2+U*(Rchol'\(z-z1));         %Back substitution to get state update
%V_error=z-z1;

U = P12 / S;   % for scalar z
x = x2 + U*(z - z1);
V_error=z-z1;

%% START ==================================

P=P-U*U';                   %Covariance update, U*U'=P12/R/R'*P12'=K*P12.
P = (P + P')/2;               % force symmetry
P = P + 1e-12*eye(nx);   % ensure positive definite


% --- 5. Clamp SOC ---
x(4) = min(max(x(4),0),1);

%% END ===================================


% function [F_val]=F_fun(xf1)
% F_val=[( 1-dt/(R1*C1) )*xf1(1)+dt*curr/C1;...
%        ( 1-dt/(R2*C2) )*xf1(2)+dt*curr/C2;...
%        ( 1-dt/(R3*C3) )*xf1(3)+dt*curr/C3;...
%        xf1(4)-dt*eta*curr];  % nonlinear state equations
% end


function [z,A]=jaccsd1(f,x3)
% JACCSD Jacobian through complex step differentiation
            % [z J] = jaccsd(f,x)
            % z = f(x)
            % J = f'(x)
    %
    z=f(x3);
    n=numel(x3);
    m=numel(z);
    A=zeros(m,n);
    h1=1e-6;
    for k=1:n
        x1=x3;
        x1(k)=(x1(k)+h1);
        A(:,k)=(f(x1)-z)/h1;
    end
end


function [z,A]=jaccsd2(h, x3)
% JACCSD Jacobian through complex step differentiation
            % [z J] = jaccsd(f,x)
            % z = f(x)
            % J = f'(x)
    z=h(x3);
    n=numel(x3);
    m=numel(z);
    A=zeros(m,n);
    h1=n*eps;
    for k=1:n
        x1=x3;
        x1(k)=(x1(k)+h1);
        A(:,k)=(h(x1)-z)/h1;
    end
end


end
end

